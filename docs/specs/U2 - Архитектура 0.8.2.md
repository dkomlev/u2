Принял правки. Ниже — обновлённые архитектура и план с учётом ваших замечаний. Coupled перенесён на M5+ и не требуется для ранних сборок; по умолчанию **Stabilized**. Все упоминания Coupled и его приёмочных тестов (β, yaw‑lead, jerk‑лимиты, PA‑8…PA‑11) привязаны к ТЗ пилот‑ассиста v0.6.4.

---

## **0\) Консолидированные изменения**

1. **Приоритеты источников ввода:**  
    **Player (Local) ≥ Remote ≥ Autopilot.**  
    Ассистент — всегда **после** арбитража (модулятор/огибающая), не источник.

2. **Режим по умолчанию:** **Stabilized** (Decoupled доступен как «RAW»).  
    **Coupled** — целевой режим **M5+** (не обязателен для M0–M4).

3. **Поле c′(x):** флаг `cField.mode = Static | LoadAdaptive`.  
    По умолчанию: **Static**. **LoadAdaptive** — опционально, под жёстким логированием, не включаем до M4+.

4. **Физика в M0:** **ньютоновская** (без γ) \+ каркас cField.  
    Релятивистика (γ, F∥/F⊥) и инварианты — с **M1.1** (серверный интегратор).

5. **Док‑метки этапов:** в начале архитектурного документа добавлена таблица «Соответствие разделов этапам M0–M8»; в разделах пометки «в M0 делаем только A/B/C; D/E — M4+».

---

## **1\) Соответствие разделов этапам M0–M8**

| Раздел | M0 | M1 | M2 | M3 | M4 | M5 | M6 | M7 | M8 |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| ECS‑ядро, оффлайн камера/HUD‑минимум | ✔︎ |  |  |  |  |  |  |  |  |
| Физика: Ньютон | ✔︎ |  |  |  |  |  |  |  |  |
| Физика: СТО (γ, F∥/F⊥) |  | ✔︎ |  |  |  |  |  |  |  |
| Протокол/транспорт |  |  | ✔︎ |  |  |  |  |  |  |
| Предсказание/Recon |  |  | ✔︎ |  |  |  |  |  |  |
| Ввод и арбитраж (Local ≥ …) |  |  |  | ✔︎ |  |  |  |  |  |
| Ассисты: Decoupled/Stabilized |  |  |  | ✔︎ |  |  |  |  |  |
| Retarded Observation \+ future‑queue |  |  |  |  | ✔︎ |  |  |  |  |
| Coupled \+ приёмочные PA‑8…PA‑11 |  |  |  |  |  | ✔︎ |  |  |  |
| Lock‑target бой \+ боты |  |  |  |  |  |  | ✔︎ |  |  |
| Heat/Damage v2, Thrust Allocation |  |  |  |  |  |  |  | ✔︎ |  |
| Платформы/оптимизация |  |  |  |  |  |  |  |  | ✔︎ |

---

## **2\) Обновлённые фрагменты архитектуры**

### **2.1 Пайплайн управления (фиксировано)**

1. **Arbitration:** **Player(Local) ≥ Remote ≥ Autopilot**, по‑осевая эксклюзивность, takeover 200 мс, cross‑fade 150 мс, ED‑style дублирование, «Hold RAW» (временный обход ассиста).

2. **Assist:** режим по умолчанию **Stabilized**; Decoupled — по кнопке RAW; Coupled — **M5+**.

3. **Safety/Envelope:** лимиты ускорений/моментов, тепла/энергии, jerk; затем Allocator→Physics.

### **2.2 Поле c′(x)**

* **M0:** `cField.mode = Static` (зависит от координат; непрерывная огибающая).

* **M4+:** опция `LoadAdaptive` под логированием (по умолчанию off), без влияния на ранее замороженные интерфейсы.

### **2.3 Физика**

* **M0:** Ньютон \+ капы скорости (|v|\<c′(x) только как визуальный лимитер HUD, без γ).

* **M1.1:** включение γ и продольно/поперечной динамики; прежние API не ломаем, добавляем флаги совместимости.

---

## **3\) План M0–M8: обновления по шагам (SoT → входы/выходы → тесты/DoD)**

Ниже перечислены только строки, затронутые вашими правками; несменённые пункты остаются как в последней версии плана.

### **M0.2 Shared.Math \+ cField (упрощение)**

* **SoT.** SPEC\_math.md (Ньютон), SPEC\_cfield.md (Static‑режим).

* **Входы/выходы.** `ICField.Sample(pos)`; НЕТ γ в M0; заглушки `Relativistic.*` возвращают ньютоновские значения.

* **Тесты/DoD.** Property‑тесты для непрерывности c′; проверка, что включение γ‑флагов в M0 **ничего не меняет** (флаги игнорируются).

### **M1.1 Серверная физика (включение СТО)**

* **SoT.** SPEC\_physics2D.md (γ, F∥/F⊥).

* **Входы/выходы.** Флаги `relativity.enabled=true` на сервере; клиент предсказывает Ньютон/γ по конфигу (единой формулой).

* **Тесты/DoD.** Инварианты `|v|<0.999·c′`, корректный рост γ; регресс‑тест: при `enabled=false` траектория \= M0 в пределах ε.

### **M3.1 Арбитраж источников**

* **SoT.** SPEC\_arbitration.md (правка приоритета).

* **Входы/выходы.** Player(Local) ≥ Remote ≥ Autopilot; ассистент после арбитража.

* **Тесты/DoD.** Сценарии takeover с участием всех трёх источников: скачок тяги \< 5%, HUD показывает владельца оси корректно.

### **M3.2 Ассисты (дефолт Stabilized)**

* **SoT.** ASSIST\_SPEC\_basic.md.

* **Входы/выходы.** По умолчанию — Stabilized; Decoupled по «RAW». Параметры `w_a` и эскалации — доступны в телеметрии.

* **Тесты/DoD.** Демпфирование вращения, отсутствие «пилот‑файтинга».

### **M4.1 Observation (без LoadAdaptive)**

* **SoT.** SPEC\_observation.md.

* **Входы/выходы.** t\_flight=d/c′(x) для **Static**; `LoadAdaptive` выключен.

* **Тесты/DoD.** Планировщик показа выдерживает заданный диапазон «кадров в будущем».

### **M5.1 Coupled (как целевой режим, без требований к M0–M4)**

* **SoT.** Пилот‑ассист v0.6.4 (β, yaw‑lead, jerk‑лимиты, PA‑8…PA‑11, HUD‑телеметрия).

* **Входы/выходы.** Без изменений; включается флагом в настройках.

* **Тесты/DoD.** Только в ветке M5; ранние ветки не затрагивает.

---

## **4\) HUD: минимальный набор (приоритизация)**

1. **Скорость / c′ (%)**

2. **Тепло / критический порог (%)**

3. **Выбранная цель \+ дистанция**

4. **Задержка света до цели (мс)**

5. **Вероятность попадания (%)**

6. **Состояние ассистента (STABILIZED / TAKEOVER)**

7. **RTT / jitter** — скрыто по умолчанию, включается «Debug HUD».

**DoD (HUD‑минимум):** расхождение с серверной/локальной телеметрией ≤ 1%; FPS не проседает; переключатель Debug HUD не влияет на геймплей.

---

## **5\) Lock‑target бой: базовая формула `P_hit`**

Формализуем с клампами и единицами:

\[  
 P\_{\\text{hit}} \= \\operatorname{clamp}\\Big(  
 A\_{\\text{base}} \\cdot F\_{\\text{cal}} \\cdot F\_{\\text{dist}} \\cdot F\_{\\text{sig}} \\cdot F\_{\\text{rv}} \\cdot F\_{\\gamma},\\ 0,\\ 1\\Big)  
 \]

Где

* (A\_{\\text{base}}\\in\[0.7,0.9\]) — базовая точность по классу оружия.

* (F\_{\\text{cal}} \= \\sqrt{\\frac{\\text{caliber}}{\\text{target\_signature}}}).

* (F\_{\\text{dist}} \= \\exp\!\\left(-\\frac{\\text{distance}}{\\text{optimal\_range}}\\right)).

* (F\_{\\text{sig}} \= \\min\!\\left(1,\\frac{\\text{target\_signature}}{\\text{min\_signature}}\\right)).

* (F\_{\\text{rv}} \= \\frac{1}{1 \+ \\frac{|\\text{rel\_vel}|}{\\text{tracking\_speed}}}).

* (F\_{\\gamma} \= \\frac{1}{\\sqrt{\\gamma\_{\\text{target}}}}) (сложнее на высоких γ).

**Параметры по умолчанию (пример):**

| Оружие | Калибр | Optimal Range | Tracking Speed |
| ----- | ----- | ----- | ----- |
| Light Laser | 50 | 3000 м | 500 м/с |
| Heavy Cannon | 200 | 5000 м | 200 м/с |
| Missile | 100 | 8000 м | 300 м/с |

| Корабль | Сигнатура |
| ----- | ----- |
| Fighter | 50 |
| Frigate | 150 |
| Cruiser | 300 |

**DoD (комбат‑минимум):** при «оптимальных» условиях (P\_{\\text{hit}}\\in\[0.5,0.8\]); монотонность по дальности/скорости; на одинаковых входах сервер и клиент вычисляют одинаковое (P\_{\\text{hit}}).

---

## **6\) Приёмочные чек‑листы (обновлённые)**

### **M0 (оффлайн полёт, Ньютон)**

* Разгон до **0.5 c′** за 10–30 с в конфиге Fighter (без γ).

* Поворот на 180° без «тряски» и скачков тяг.

* Тепло накапливается при полной тяге, троттлинг включается у T\>Tmax.

* За 5 мин полёта нет «взрывов» скорости/позиции, NaN/Inf.

* HUD‑минимум показывает корректные значения.

### **M2 (онлайн 2 игрока)**

* Подключение второго игрока без крашей.

* Оба корабля видны с задержкой \~100–200 мс (retarded view).

* Reconciliation: нет «телепортов» своего корабля, расхождение \< 1.5 м при `c′=10 000`.

* RTT 50–150 мс: плавно; 300+ мс: видно лаги, но без крашей.

* Debug HUD верно показывает RTT/jitter, размер future‑queue.

### **M5 (ассистент)**

* **Stabilized**: отпуск осей → |ω| падает на 50% за ≤ 0.7 с, без перерегулирования \> 30%.

* Эскалация: при |ω| \> 90°/с ассистент поднимает влияние, HUD показывает «TAKEOVER».

* Возврат контроля после стабилизации — плавный (гистерезис ≥ 350 мс).

* (Только в ветке M5) **Coupled** проходит PA‑8…PA‑11.

### **M6 (бой)**

* Захват цели (UI) работает; сервер фиксирует события.

* «Огонь» → серверный урон; нет двойного применения.

* (P\_{\\text{hit}}) в оптимуме 50–80%; на краях падает ожидаемо.

* 4 игрока \+ 8 ботов: клиент FPS ≥ 50, сервер tick ≤ 30 мс.

---

## **7\) Что меняется в документах (и где проставить «этап»)**

* **SPEC\_arbitration.md** — приоритеты источников: **Player(Local) ≥ Remote ≥ Autopilot** (M3).

* **ASSIST\_SPEC\_basic.md** — дефолт **Stabilized** (M3); RAW‑кнопка; эскалация влияния.

* **ASSIST\_SPEC\_coupled.md** — пометка **M5+**, ссылка на приёмочные PA‑8…PA‑11.

* **SPEC\_cfield.md** — `mode=Static` (M0), `LoadAdaptive` — **M4+**, по умолчанию off, с логированием.

* **SPEC\_physics2D.md** — два режима: Newton (M0) и Relativistic (M1.1+), совместимый API.

* **HUD\_SPEC.md** — приоритизация индикаторов (этот список), Debug HUD скрыт.

* **SPEC\_combat.md** — формула `P_hit` с параметрами по умолчанию и клампами.

---

## **8\) Нерушимые правила заморозки**

* Любой следующий этап **не меняет публичные интерфейсы предыдущего**, кроме расширения назад‑совместимыми полями/флагами.

* Любая «усложняющая» опция (γ, Coupled, LoadAdaptive) — под флагом, выключена по умолчанию на ранних этапах.

* Детерминизм кода, который исполняется и на клиенте, и на сервере (ассистенты, физика), обязателен.

---

## **9\) Следующие действия**

1. Отметить в архитектурном документе табличку «Соответствие разделов этапам M0–M8».

2. Обновить: **SPEC\_arbitration.md**, **ASSIST\_SPEC\_basic.md**, **SPEC\_cfield.md**, **SPEC\_physics2D.md**, **HUD\_SPEC.md**, **SPEC\_combat.md**.

3. В трекере: переоткрыть задачи M0.2 и M1.1 с уточнёнными SoT/DoD; пометить Coupled задачами M5+ и снять зависимость ранних этапов от Coupled.

4. Включить в HUD «выбранная цель, дистанция, задержка света, P\_hit, состояние ассистента, RTT/jitter (debug)».

Если нужно, сформирую патч‑версию плана задач (issue‑шаблоны) и обновлённые разделы SPEC/\* с маркировкой этапов. 

